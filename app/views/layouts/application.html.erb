<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <META http-equiv="content-type" content="text/html; charset=utf-8">

	<TITLE>Everest Editor</TITLE>

  <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track' => true %>
  <%= javascript_include_tag 'application', 'data-turbolinks-track' => true %>
  <%= csrf_meta_tags %>

  <script type="text/javascript">
      $(document).ready(function() {
        $( "#workspace" ).workspace();
        workspace = $( "#workspace" ).workspace("instance");
         workspace.delegate = new Repository("http://localhost:3001/api/documents");
        setTimeout(function(){
           window.ace.config.set("basePath", "assets/workspace/src/ace-build")
         },1000)
        $("#addTab").click(function(){
          //require("ace/ext/language_tools");
         
          workspace.open("","",AceWorkspaceEditor,{ace:window.ace,mode:"ace/mode/cql"})
        });

        $.get("/api/documents").then( function (data) {
          treejson = []
          for (var key in data){
            treejson.push({"id": key, "parent": "#", "text": key})
            for (var i = 0; i < data[key].length; i++){
              if(data[key][i]) {
                treejson.push({"id": key+"/"+data[key], "parent": key, "text": data[key][i]})
              }
            }
          }

          $('#jstree').jstree({"core": {
              "data": treejson
            }
          }).bind("select_node.jstree", function(e, data) {
            filename = data.selected[0]
            if(data.node.children.length == 0){
              $.get("/api/documents/" + filename).then( function (resp) {
                var tabs = workspace.tabs.tabs("instance").tabs
                for(var i = 0; i < tabs.length; i++) {
                  if($(tabs[i]).data().editor.name == filename) {
                    workspace.tabs.tabs("option", "active", i);
                    return;
                  }
                }
                window.ace.config.set("basePath", "assets/workspace/src/ace-build")
                workspace.open(data.selected[0], resp, AceWorkspaceEditor,{ace:window.ace,mode:"ace/mode/cql"})
              });
            }
          });
        });
       }
      );

  </script>

</head>
<body>

<%= yield %>

</body>
</html>
